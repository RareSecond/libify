name: Code Quality

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  code-quality:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Generate Prisma client
        run: cd backend && npx prisma generate

      - name: Setup PostgreSQL
        uses: ikalnytskyi/action-setup-postgres@v7
        with:
          postgres-version: "17"
        id: postgres

      - name: Run Prisma migrations
        run: cd backend && npx prisma migrate deploy
        env:
          DATABASE_URL: ${{ steps.postgres.outputs.connection-uri }}

      - name: Check for schema drift
        run: |
          cd backend

          echo "Checking for schema drift..."
          npx prisma migrate dev --name ci_drift_check --create-only

          MIGRATION_FILE=$(ls -t prisma/migrations/*/migration.sql | head -n 1)

          if grep -v '^\s*--' "$MIGRATION_FILE" | grep -v '^\s*$' | grep -q .; then
            echo "❌ Schema drift detected!"
            echo ""
            echo "Migration that would be generated:"
            cat "$MIGRATION_FILE"
            rm -rf "$(dirname "$MIGRATION_FILE")"
            exit 1
          fi

          rm -rf "$(dirname "$MIGRATION_FILE")"
          echo "✅ Schema is in sync with database"
        env:
          DATABASE_URL: ${{ steps.postgres.outputs.connection-uri }}

      - name: Generate Orval API client
        run: cd frontend && npx orval

      - name: Run code quality checks
        run: npm run cq
        env:
          JWT_SECRET: test-jwt-secret-for-ci
          DATABASE_URL: postgresql://test:test@localhost:5432/test
          NODE_ENV: test
